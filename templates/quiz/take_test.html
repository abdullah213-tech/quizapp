{% load static %}
<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ quiz.title }} - Quiz Application</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="test-page">
    <!-- Proctoring Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <h2>âš ï¸ ADVANCED AI PROCTORING SYSTEM</h2>
            <p><strong>Before starting the test, you MUST:</strong></p>
            <ul style="line-height: 2;">
                <li>âœ… Enable your camera (required for face detection)</li>
                <li>âœ… Share your <strong>ENTIRE DESKTOP/MONITOR</strong> (full screen only)</li>
                <li>âœ… Ensure your face is visible and well-lit</li>
                <li>âœ… Be alone in the room (no other people)</li>
            </ul>
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                <p style="margin: 0; color: #856404; font-weight: bold;">ğŸ–¥ï¸ DESKTOP SCREEN SHARING REQUIRED:</p>
                <ul style="color: #856404; margin-top: 0.5rem; line-height: 1.8;">
                    <li>âœ… <strong>Must share:</strong> Entire Desktop/Monitor (full screen)</li>
                    <li>âŒ <strong>Not allowed:</strong> Chrome tabs, application windows, or browser windows</li>
                    <li>ğŸ” System automatically validates screen type</li>
                    <li>âš ï¸ Invalid screen sharing = Setup fails</li>
                </ul>
            </div>
            <div style="background: #fff5f5; border-left: 4px solid #e53e3e; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                <p style="margin: 0; color: #c53030; font-weight: bold;">ğŸ¤– AI MONITORING - AUTOMATIC FAIL IF:</p>
                <ul style="color: #742a2a; margin-top: 0.5rem; line-height: 1.8;">
                    <li>ğŸš« No face detected (3 times) - camera blocked or left seat</li>
                    <li>ğŸš« Multiple faces detected (2 times) - unauthorized assistance</li>
                    <li>ğŸš« Looking away from screen repeatedly (5 times) - using phone/notes</li>
                    <li>ğŸ“± <strong>MOBILE PHONE USAGE DETECTED - Advanced AI monitors:</strong>
                        <ul style="margin-top: 0.3rem;">
                            <li>â€¢ Repeated downward glances (checking phone in lap)</li>
                            <li>â€¢ Hands out of camera frame (holding phone)</li>
                            <li>â€¢ Phone screen reflections in face/glasses</li>
                            <li>â€¢ Suspicious lighting patterns from phone screen</li>
                        </ul>
                    </li>
                    <li>ğŸš« <strong>Open test in multiple browser windows or profiles</strong></li>
                    <li>ğŸš« Switch tabs or open new tabs</li>
                    <li>ğŸš« Minimize the browser window</li>
                    <li>ğŸš« Click outside the browser window</li>
                    <li>ğŸš« Exit fullscreen mode</li>
                    <li>ğŸš« Stop screen sharing</li>
                    <li>ğŸš« Copy/paste attempts</li>
                    <li>ğŸš« Print or screenshot attempts</li>
                </ul>
            </div>
            <div style="background: #fef5e7; border-left: 4px solid #f39c12; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                <p style="margin: 0; color: #d35400; font-weight: bold;">ğŸ”’ SINGLE BROWSER INSTANCE ONLY:</p>
                <ul style="color: #8e5f0f; margin-top: 0.5rem; line-height: 1.8;">
                    <li>âœ“ Use ONLY ONE browser window/tab for this test</li>
                    <li>âœ“ Do NOT open the test in multiple browsers (Chrome, Firefox, etc.)</li>
                    <li>âœ“ Do NOT use different browser profiles</li>
                    <li>âœ“ System detects and blocks multiple instances automatically</li>
                    <li>âš ï¸ Opening test elsewhere = Instant disqualification</li>
                </ul>
            </div>
            <p style="color: #c53030; font-weight: bold; margin-top: 1rem;">
                âš¡ AI face detection active every 3 seconds | No second chances | Instant disqualification
            </p>
            <div style="background: #edf2f7; border: 2px solid #667eea; padding: 1.5rem; margin: 1rem 0; border-radius: 8px;">
                <p style="margin: 0 0 1rem 0; color: #2d3748; font-weight: bold; font-size: 1.1rem;">ğŸ“– HOW TO SHARE YOUR DESKTOP:</p>
                <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <p style="margin: 0 0 0.5rem 0; color: #2d3748; font-weight: bold;">When the screen sharing dialog appears:</p>
                    <ol style="margin: 0.5rem 0 0 1.2rem; color: #4a5568; line-height: 1.8;">
                        <li><strong style="color: #48bb78;">âœ… Click "Entire screen" tab</strong> at the top of the dialog</li>
                        <li><strong style="color: #48bb78;">âœ… Select your main desktop/monitor</strong> from the preview</li>
                        <li><strong style="color: #48bb78;">âœ… Click the blue "Share" button</strong> to confirm</li>
                    </ol>
                </div>
                <div style="background: #fff5f5; padding: 1rem; border-radius: 6px; border-left: 4px solid #e53e3e;">
                    <p style="margin: 0 0 0.5rem 0; color: #c53030; font-weight: bold;">âŒ DO NOT SELECT:</p>
                    <ul style="margin: 0.5rem 0 0 1.2rem; color: #742a2a; line-height: 1.8;">
                        <li>âŒ "Chrome tab" or "Browser tab"</li>
                        <li>âŒ "Window" or "Application window"</li>
                        <li>âŒ Any individual program or application</li>
                    </ul>
                </div>
                <div style="background: #e6fffa; padding: 1rem; border-radius: 6px; border-left: 4px solid #38b2ac; margin-top: 1rem;">
                    <p style="margin: 0; color: #234e52; font-weight: bold;">ğŸ”’ AUTOMATIC VALIDATION:</p>
                    <ul style="margin: 0.5rem 0 0 1.2rem; color: #234e52; line-height: 1.8;">
                        <li>âœ“ System checks screen type automatically</li>
                        <li>âœ“ Validates desktop/monitor selection</li>
                        <li>âœ“ Checks screen resolution</li>
                        <li>âœ“ Monitors throughout entire test</li>
                    </ul>
                </div>
                <p style="margin: 1rem 0 0 0; color: #e53e3e; font-weight: bold; text-align: center;">
                    âš ï¸ Only ENTIRE DESKTOP/MONITOR sharing is accepted! Window/tab sharing will be rejected!
                </p>
            </div>
            <div id="permissionStatus">
                <p id="cameraStatus">ğŸ“¹ Camera: <span class="status-pending">Pending</span></p>
                <p id="screenStatus">ğŸ–¥ï¸ Desktop Share (Monitor): <span class="status-pending">Pending</span></p>
            </div>
            <button id="setupBtn" class="btn btn-primary btn-lg">I Understand - Start Setup</button>
            <button id="startTestBtn" class="btn btn-success btn-lg" style="display:none;">âœ… Start Test</button>
        </div>
    </div>

    <!-- Video Preview (hidden) -->
    <div id="videoPreview" style="position: fixed; bottom: 10px; right: 10px; width: 200px; z-index: 1000; display: none;">
        <video id="cameraVideo" autoplay muted style="width: 100%; border: 2px solid #007bff; border-radius: 8px;"></video>
    </div>

    <!-- Test Interface -->
    <div id="testInterface" style="display: none;">
        <div class="test-header">
            <div class="container">
                <h1>{{ quiz.title }}</h1>
                <div class="test-info">
                    <span class="student-name">ğŸ‘¤ {{ student_name }}</span>
                    <span class="timer" id="timer">â±ï¸ <span id="timeRemaining">{{ duration_minutes }}:00</span></span>
                </div>
            </div>
        </div>

        <div class="container test-container" style="max-height: calc(100vh - 100px); overflow-y: auto; padding-bottom: 2rem;">
            <div class="quiz-description">
                <p>{{ quiz.description }}</p>
                <div style="background: #fff5f5; border-left: 4px solid #e53e3e; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
                    <p style="color: #c53030; font-weight: bold; margin-bottom: 0.5rem;">ğŸ¤– AI PROCTORING ACTIVE:</p>
                    <ul style="color: #742a2a; margin: 0;">
                        <li>ğŸ‘ï¸ Face detection monitoring (every 3 seconds)</li>
                        <li>ğŸ“± <strong>Mobile phone usage detection (advanced AI)</strong></li>
                        <li>ğŸ“¹ Camera recording your face</li>
                        <li>ğŸ–¥ï¸ <strong>Entire Desktop/Monitor being shared</strong></li>
                        <li>ğŸ” Screen share type validated continuously</li>
                        <li>ğŸ” <strong>Single browser instance enforced</strong></li>
                        <li>ğŸ’» Browser fingerprinting active</li>
                        <li>ğŸ”’ Fullscreen mode enforced</li>
                        <li>ğŸ–±ï¸ Mouse movement tracked</li>
                        <li>ğŸ“‹ Clipboard actions blocked</li>
                        <li>âš ï¸ Any violation = Instant FAIL</li>
                    </ul>
                </div>
                <p><strong>Instructions:</strong></p>
                <ul>
                    <li>Answer all questions to the best of your ability</li>
                    <li>Stay in fullscreen mode throughout the test</li>
                    <li>Keep the browser window focused at all times</li>
                    <li>Click "Submit Test" when finished</li>
                </ul>
            </div>

            <form id="quizForm">
                {% for question in questions %}
                <div class="question-card" data-question-id="{{ question.id }}">
                    <div class="question-header">
                        <span class="question-number">Question {{ forloop.counter }}</span>
                        <span class="question-points">{{ question.points }} point{{ question.points|pluralize }}</span>
                    </div>
                    <p class="question-text">{{ question.question_text }}</p>
                    
                    {% if question.question_type == 'multiple_choice' %}
                        <div class="choices">
                            {% for choice in question.choices.all %}
                            <label class="choice-label">
                                <input type="radio" 
                                       name="question_{{ question.id }}" 
                                       value="{{ choice.id }}"
                                       data-question-id="{{ question.id }}"
                                       data-choice-id="{{ choice.id }}">
                                <span>{{ choice.choice_text }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    {% elif question.question_type == 'true_false' %}
                        <div class="choices">
                            {% for choice in question.choices.all %}
                            <label class="choice-label">
                                <input type="radio" 
                                       name="question_{{ question.id }}" 
                                       value="{{ choice.id }}"
                                       data-question-id="{{ question.id }}"
                                       data-choice-id="{{ choice.id }}">
                                <span>{{ choice.choice_text }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    {% elif question.question_type == 'short_answer' %}
                        <textarea name="question_{{ question.id }}_text" 
                                  class="short-answer"
                                  data-question-id="{{ question.id }}"
                                  rows="4"
                                  placeholder="Type your answer here..."></textarea>
                    {% elif question.question_type == 'coding_js' or question.question_type == 'coding_python' %}
                        <div class="code-editor-container">
                            <div class="code-editor-header">
                                <span class="language-badge">
                                    {% if question.question_type == 'coding_js' %}
                                        ğŸŸ¨ JavaScript
                                    {% else %}
                                        ğŸ Python
                                    {% endif %}
                                </span>
                                <button type="button" 
                                        class="btn-run-code" 
                                        data-question-id="{{ question.id }}"
                                        data-language="{% if question.question_type == 'coding_js' %}javascript{% else %}python{% endif %}">
                                    â–¶ï¸ Run Code
                                </button>
                            </div>
                            <textarea class="code-editor" 
                                      name="question_{{ question.id }}_code"
                                      data-question-id="{{ question.id }}"
                                      data-language="{% if question.question_type == 'coding_js' %}javascript{% else %}python{% endif %}"
                                      rows="15"
                                      spellcheck="false">{% if question.starter_code %}{{ question.starter_code }}{% else %}// Write your code here{% endif %}</textarea>
                            <div class="code-output" id="output_{{ question.id }}">
                                <div class="output-header">ğŸ’» Output:</div>
                                <pre class="output-content" id="output_content_{{ question.id }}">Run your code to see output here...</pre>
                                <div class="execution-time" id="exec_time_{{ question.id }}" style="display:none;">
                                    â±ï¸ Execution time: <span></span>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% endfor %}

                <div class="test-actions">
                    <button type="button" id="submitTestBtn" class="btn btn-success btn-lg">Submit Test</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Disqualification Modal -->
    <div id="disqualifyModal" class="modal" style="display: none;">
        <div class="modal-content error">
            <h2>Test Terminated</h2>
            <p id="disqualifyReason">You have been disqualified from this test.</p>
            <p>Your test has been automatically failed.</p>
        </div>
    </div>

    <script>
        const ATTEMPT_ID = {{ attempt.id }};
        const DURATION_MINUTES = {{ duration_minutes }};
        const CSRF_TOKEN = '{{ csrf_token }}';
    </script>
    <script src="{% static 'js/session_manager.js' %}"></script>
    <script src="{% static 'js/phone_detection.js' %}"></script>
    <script src="{% static 'js/proctoring.js' %}"></script>
    <script src="{% static 'js/quiz.js' %}"></script>
    <script src="{% static 'js/code_editor.js' %}"></script>
</body>
</html>

